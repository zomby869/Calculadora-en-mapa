<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculador de precio por km</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f4f4;color:#222}
    .wrap{max-width:900px;margin:18px auto;padding:18px}
    .card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    h2{margin-bottom:16px;text-align:center;color:#0b74de}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    input[type="text"],button{
      padding:12px;border-radius:8px;border:1px solid #d0d0d0;font-size:16px;flex:1;min-width:180px;
    }
    button{
      cursor:pointer;
      background:#0b74de;
      color:#fff;
      border:none;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover{background:#095bb5; transform: translateY(-2px);}
    #map{height:380px;border-radius:10px;margin-top:12px}
    #resultado{margin-top:16px;font-weight:600}
    .precios-fijos{
      margin-bottom:16px;
      background:#e8f0fe;
      padding:12px 16px;
      border-radius:10px;
      font-weight:600;
      display:flex;
      gap:30px;
      justify-content:center;
      font-size:16px;
    }
    #btnSolicitar{
      display:none;
      margin-top:16px;
      padding:12px 20px;
      font-size:16px;
      border-radius:8px;
    }
    #resultado-box{
      background:#f0f8ff;
      border-radius:12px;
      padding:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      display:flex;
      flex-direction:column;
      gap:12px;
      font-size:16px;
    }
    @media(min-width:900px){
      .controls{display:flex;gap:12px}
      #map{height:480px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Calculador de precio por km</h2>
      
      <!-- Valores fijos siempre visibles -->
      <div class="precios-fijos">
        <div>Precio de bajada: $1000.00</div>
        <div>Precio por km: $500.00</div>
      </div>

      <div class="row controls">
        <input id="origen" type="text" placeholder="Origen (ej. Calle y Número o barrio)" />
        <input id="destino" type="text" placeholder="Destino" />
      </div>
      <div class="row">
        <button id="btnCalcular">Calcular</button>
      </div>

      <div id="resultado">
        <div id="resultado-box">Ingresá origen y destino y presioná «Calcular».</div>
      </div>
      <button id="btnSolicitar">Solicitar</button>
      <div id="map"></div>
      <small style="display:block;margin-top:12px;color:#666;text-align:center">
        Consejo: usá las sugerencias automáticas al escribir (autocomplete). Si no ves sugerencias o aparece error, mirá la consola del navegador (F12).
      </small>
    </div>
  </div>

  <script>
    let map, directionsService, directionsRenderer, autocompleteOrigen, autocompleteDestino;

    const TARIFA_KM = 500;
    const PRECIO_BAJADA = 1000;
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxGyZy-HQsZlcLMOObE2LXTI_VofqxXzL0dDFgb7l2BB2GkLHbExHaMCvgw6WJHeTKW/exec"; // reemplazá con tu URL de Apps Script

    function initMap() {
      const centro = { lat: -38.9516, lng: -68.0596 };
      map = new google.maps.Map(document.getElementById("map"), { center: centro, zoom: 12, mapTypeControl: false });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false });

      autocompleteOrigen = new google.maps.places.Autocomplete(document.getElementById("origen"), { fields: ["formatted_address", "geometry", "name"] });
      autocompleteDestino = new google.maps.places.Autocomplete(document.getElementById("destino"), { fields: ["formatted_address", "geometry", "name"] });

      document.getElementById("btnCalcular").addEventListener("click", calcular);
      document.getElementById("btnSolicitar").addEventListener("click", enviarMail);
    }

    let ultimoCalculo = null;

    function calcular() {
      const origen = document.getElementById("origen").value.trim();
      const destino = document.getElementById("destino").value.trim();

      if (!origen || !destino) { alert("Ingresá origen y destino."); return; }

      const dms = new google.maps.DistanceMatrixService();
      dms.getDistanceMatrix({
        origins: [origen],
        destinations: [destino],
        travelMode: 'DRIVING',
        unitSystem: google.maps.UnitSystem.METRIC,
        avoidTolls: false
      }, (response, status) => {
        if (status !== 'OK') {
          console.error("DistanceMatrix error:", status, response);
          alert("Error al calcular la distancia: " + status);
          return;
        }

        const element = response.rows[0].elements[0];
        if (element.status !== "OK") {
          alert("No se pudo calcular la distancia: " + element.status);
          return;
        }

        const distanciaKm = element.distance.value / 1000;
        const precioTotal = PRECIO_BAJADA + (distanciaKm * TARIFA_KM);

        // Mostrar resultado
        document.getElementById("resultado-box").innerHTML = `
          <div><strong>Distancia:</strong> ${element.distance.text} (${distanciaKm.toFixed(2)} km)</div>
          <div style="font-size:1.1em;font-weight:700;text-align:right;">Precio total: $${precioTotal.toFixed(2)}</div>
        `;

        ultimoCalculo = { origen, destino, distancia: distanciaKm.toFixed(2), precioTotal: precioTotal.toFixed(2) };

        // Mostrar botón solicitar
        const btn = document.getElementById("btnSolicitar");
        btn.style.display = "block";
        btn.scrollIntoView({behavior:"smooth"});

        // Mostrar ruta en mapa
        directionsService.route({
          origin: origen,
          destination: destino,
          travelMode: google.maps.TravelMode.DRIVING
        }, (routeResult, routeStatus) => {
          if (routeStatus === 'OK') directionsRenderer.setDirections(routeResult);
          else console.warn("DirectionsService:", routeStatus);
        });
      });
    }

    function enviarMail() {
      if(!ultimoCalculo) { alert("Primero realizá un cálculo."); return; }

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(ultimoCalculo),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        if(data.status === "ok") {
          alert("Solicitud enviada correctamente.");
          document.getElementById("btnSolicitar").style.display = "none";
        } else {
          alert("Error al enviar la solicitud: " + data.message);
        }
      })
      .catch(err => {
        alert("Error al enviar la solicitud: " + err.message);
        console.error(err);
      });
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4BTT3rUnL-gGpHZj05kkcZYmTnzY7BRo&libraries=places&callback=initMap">
  </script>
</body>
</html>


